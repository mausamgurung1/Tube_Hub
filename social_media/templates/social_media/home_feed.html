{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <!-- Upload buttons -->
            <div class="mb-4">
                <a href="{% url 'social_media:upload_photo' %}" class="btn btn-primary me-2">
                    <i class="fas fa-camera"></i> Upload Photo
                </a>
                <a href="{% url 'social_media:upload_short' %}" class="btn btn-primary">
                    <i class="fas fa-video"></i> Upload Video
                </a>
            </div>

            <!-- Feed -->
            {% for post in posts %}
            <div class="card mb-4">
                <!-- Post header -->
                <div class="card-header d-flex align-items-center">
                    <img src="{{ post.user.profile.image.url|default:'/static/default_profile.png' }}" 
                         class="rounded-circle me-2" width="32" height="32">
                    <div>
                        <h6 class="mb-0">{{ post.user.username }}</h6>
                        <small class="text-muted">{{ post.created_at|timesince }} ago</small>
                    </div>
                </div>

                <!-- Post content -->
                <div class="card-body p-0">
                    {% if post.image %}
                        <!-- Photo post -->
                        <img src="{{ post.image.url }}" class="img-fluid w-100" alt="Post image">
                    {% else %}
                        <!-- Video post -->
                        <video class="w-100" controls>
                            <source src="{{ post.video.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    {% endif %}
                </div>

                <!-- Post actions -->
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-link p-0 me-2 like-btn" 
                                    data-post-type="{% if post.image %}photo{% else %}short{% endif %}"
                                    data-post-id="{{ post.id }}">
                                <i class="far fa-heart"></i>
                                <span class="likes-count">{{ post.likes.count }}</span>
                            </button>
                            <button class="btn btn-link p-0 comment-btn">
                                <i class="far fa-comment"></i>
                            </button>
                        </div>
                        <div>
                            <a href="{% if post.image %}{% url 'social_media:send_photo_gift' post.id %}{% else %}{% url 'social_media:send_short_gift' post.id %}{% endif %}"
                               class="btn btn-link p-0">
                                <i class="fas fa-gift"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Caption -->
                    <p class="mt-2 mb-0">{{ post.caption }}</p>

                    <!-- Comments section -->
                    <div class="comments-section mt-3">
                        {% for comment in post.comments.all|slice:":5" %}
                            <div class="comment mb-2">
                                <strong>{{ comment.user.username }}</strong>
                                <span>{{ comment.content }}</span>
                            </div>
                        {% endfor %}
                        <form class="comment-form mt-2" 
                              action="{% if post.image %}{% url 'social_media:add_photo_comment' post.id %}{% else %}{% url 'social_media:add_short_comment' post.id %}{% endif %}"
                              method="post">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="text" class="form-control" name="content" placeholder="Add a comment...">
                                <button type="submit" class="btn btn-primary">Post</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% empty %}
                <div class="text-center">
                    <p>No posts yet. Be the first to share!</p>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Like button functionality
    document.querySelectorAll('.like-btn').forEach(button => {
        button.addEventListener('click', function() {
            const postType = this.dataset.postType;
            const postId = this.dataset.postId;
            const icon = this.querySelector('i');
            const countSpan = this.querySelector('.likes-count');
            
            fetch(`/social/${postType}s/${postId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    icon.classList.toggle('far');
                    icon.classList.toggle('fas');
                    countSpan.textContent = data.likes_count;
                }
            });
        });
    });

    // Comment form submission
    document.querySelectorAll('.comment-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const commentsSection = this.closest('.comments-section');
                    const newComment = document.createElement('div');
                    newComment.className = 'comment mb-2';
                    newComment.innerHTML = `<strong>${data.comment.user}</strong> <span>${data.comment.content}</span>`;
                    commentsSection.insertBefore(newComment, this);
                    this.reset();
                }
            });
        });
    });
});
</script>
{% endblock %}
{% endblock %} 